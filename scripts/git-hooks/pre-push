#!/bin/bash
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel)"
cd "$ROOT"

UPSTREAM=""
if git rev-parse --abbrev-ref --symbolic-full-name @{u} >/dev/null 2>&1; then
  UPSTREAM="@{u}"
fi

if [ -n "$UPSTREAM" ]; then
  CHANGED="$(git diff --name-only "$UPSTREAM"...HEAD)"
else
  CHANGED="$(git diff --name-only HEAD~1..HEAD 2>/dev/null || true)"
fi

if [ -z "$CHANGED" ]; then
  exit 0
fi

needs_api=0
while IFS= read -r file; do
  case "$file" in
    cloudfunctions/*|cloudbase-backend/*|supabase/functions/*|api/*|system-assets/contracts/*|api-contract.md)
      needs_api=1
      break
      ;;
  esac
done <<< "$CHANGED"

if [ "$needs_api" -ne 1 ]; then
  exit 0
fi

warn() { echo "WARN: $1"; }

syntax_check() {
  if [ -d "$ROOT/smoke-tests" ]; then
    for f in "$ROOT"/smoke-tests/*.sh; do
      [ -f "$f" ] && bash -n "$f"
    done
  fi
  if [ ! -f "$ROOT/api-contract.md" ]; then
    echo "api-contract.md is required."
    exit 1
  fi
}

if [ -z "${API_BASE:-}" ]; then
  warn "API_BASE is not set. Skipping live smoke; running syntax checks only."
  warn "Set it like: API_BASE=https://your-api.example.com git push"
  syntax_check
  exit 0
fi

health_code="$(curl -sS -o /dev/null -w "%{http_code}" "${API_BASE}/health" || echo "000")"
if [ "$health_code" != "200" ]; then
  warn "Health check failed (status $health_code). Skipping live smoke; running syntax checks only."
  warn "Possible causes: CloudBase root domain not mapped or /health unavailable."
  syntax_check
  exit 0
fi

if [ -z "${SMOKE_PROFILE:-}" ]; then
  export SMOKE_PROFILE="core-sync"
fi

if [ -f "$ROOT/smoke-tests/smoke.curl.sh" ]; then
  API_BASE="$API_BASE" bash "$ROOT/smoke-tests/smoke.curl.sh"
elif [ -f "$ROOT/smoke-tests/smoke.generated.curl.sh" ]; then
  API_BASE="$API_BASE" bash "$ROOT/smoke-tests/smoke.generated.curl.sh"
else
  echo "No smoke test script found in smoke-tests/."
  exit 1
fi
